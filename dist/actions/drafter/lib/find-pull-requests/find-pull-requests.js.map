{"version":3,"file":"find-pull-requests.js","sources":["../../../../../src/actions/drafter/lib/find-pull-requests/find-pull-requests.ts"],"sourcesContent":["import { Config } from 'src/types'\nimport { findPreviousReleases } from '../find-previous-releases'\nimport { context } from '@actions/github'\nimport { findCommitsWithPathChange } from './find-commits-with-path-change'\nimport core from '@actions/core'\nimport { findCommitsWithPr } from './find-commits-with-pr'\nimport _ from 'lodash'\n\nexport const findPullRequests = async (params: {\n  lastRelease: Awaited<ReturnType<typeof findPreviousReleases>>['lastRelease']\n  config: Config\n}) => {\n  const since =\n    params.lastRelease?.created_at || params.config['initial-commits-since']\n\n  const shouldfilterByChangedPaths = params.config['include-paths'].length > 0\n\n  /**\n   * If include-paths are specified,\n   * find all commits that changed those paths to filter PRs later\n   *\n   * The underlying query does not bother fetching PRs along commits.\n   */\n  let commitIdsMatchingPaths: Record<string, Set<string>> = {}\n  if (shouldfilterByChangedPaths) {\n    core.info('Finding commits with path changes...')\n    const {\n      commitIdsMatchingPaths: commitIdsMatchingPathsRes,\n      hasFoundCommits\n    } = await findCommitsWithPathChange(params.config['include-paths'], {\n      since,\n      name: context.repo.repo,\n      owner: context.repo.owner,\n      targetCommitish: params.config.commitish\n    })\n\n    // Short circuit to avoid blowing GraphQL budget\n    if (!hasFoundCommits) {\n      return { commits: [], pullRequests: [] }\n    }\n\n    commitIdsMatchingPaths = commitIdsMatchingPathsRes\n    Object.entries(commitIdsMatchingPaths).forEach(([path, ids]) => {\n      core.info(`Found ${ids.size} commits with changes to path \"${path}\"`)\n    })\n  }\n\n  core.info(\n    `Fetching parent commits of ${params.config['commitish']}${since ? ` since ${since}` : ''}...`\n  )\n\n  let commits = await findCommitsWithPr({\n    since,\n    name: context.repo.repo,\n    owner: context.repo.owner,\n    targetCommitish: params.config.commitish,\n    withPullRequestBody: params.config['change-template'].includes('$BODY'),\n    withPullRequestURL: params.config['change-template'].includes('$URL'),\n    withBaseRefName:\n      params.config['change-template'].includes('$BASE_REF_NAME'),\n    withHeadRefName:\n      params.config['change-template'].includes('$HEAD_REF_NAME'),\n    pullRequestLimit: params.config['pull-request-limit'],\n    historyLimit: params.config['history-limit']\n  })\n\n  core.info(`Found ${commits.length} commits.`)\n\n  // Filter-out commits that did not change specified paths\n  commits = shouldfilterByChangedPaths\n    ? commits.filter((commit) =>\n        params.config['include-paths'].some((path) =>\n          commitIdsMatchingPaths[path].has(commit.id)\n        )\n      )\n    : commits\n\n  if (shouldfilterByChangedPaths) {\n    core.info(\n      `After filtering by path changes, ${commits.length} commits remain.`\n    )\n  }\n\n  // Extract PRs from commits\n  let pullRequests = _.uniqBy(\n    commits.flatMap((commit) => commit.associatedPullRequests?.nodes),\n    'number'\n  ).filter((pr) => !!pr)\n\n  core.info(\n    `Found ${pullRequests.length} pull requests associated with those commits.`\n  )\n\n  pullRequests = pullRequests.filter(\n    (pr) =>\n      // Ensure PR is from the same repository\n      pr.baseRepository?.nameWithOwner ===\n        `${context.repo.owner}/${context.repo.repo}` &&\n      // Ensure PR is merged\n      pr.merged\n  )\n\n  core.info(\n    `After filtering, ${pullRequests.length} pull requests remain : ${pullRequests\n      .map((pr) => `#${pr.number}`)\n      .join(', ')}`\n  )\n\n  return { commits, pullRequests }\n}\n"],"names":["context"],"mappings":";;;;;AAQO,MAAM,mBAAmB,OAAO,WAGjC;AACJ,QAAM,QACJ,OAAO,aAAa,cAAc,OAAO,OAAO,uBAAuB;AAEzE,QAAM,6BAA6B,OAAO,OAAO,eAAe,EAAE,SAAS;AAQ3E,MAAI,yBAAsD,CAAA;AAC1D,MAAI,4BAA4B;AAC9B,SAAK,KAAK,sCAAsC;AAChD,UAAM;AAAA,MACJ,wBAAwB;AAAA,MACxB;AAAA,IAAA,IACE,MAAM,0BAA0B,OAAO,OAAO,eAAe,GAAG;AAAA,MAClE;AAAA,MACA,MAAMA,cAAAA,QAAQ,KAAK;AAAA,MACnB,OAAOA,cAAAA,QAAQ,KAAK;AAAA,MACpB,iBAAiB,OAAO,OAAO;AAAA,IAAA,CAChC;AAGD,QAAI,CAAC,iBAAiB;AACpB,aAAO,EAAE,SAAS,IAAI,cAAc,CAAA,EAAC;AAAA,IACvC;AAEA,6BAAyB;AACzB,WAAO,QAAQ,sBAAsB,EAAE,QAAQ,CAAC,CAAC,MAAM,GAAG,MAAM;AAC9D,WAAK,KAAK,SAAS,IAAI,IAAI,kCAAkC,IAAI,GAAG;AAAA,IACtE,CAAC;AAAA,EACH;AAEA,OAAK;AAAA,IACH,8BAA8B,OAAO,OAAO,WAAW,CAAC,GAAG,QAAQ,UAAU,KAAK,KAAK,EAAE;AAAA,EAAA;AAG3F,MAAI,UAAU,MAAM,kBAAkB;AAAA,IACpC;AAAA,IACA,MAAMA,cAAAA,QAAQ,KAAK;AAAA,IACnB,OAAOA,cAAAA,QAAQ,KAAK;AAAA,IACpB,iBAAiB,OAAO,OAAO;AAAA,IAC/B,qBAAqB,OAAO,OAAO,iBAAiB,EAAE,SAAS,OAAO;AAAA,IACtE,oBAAoB,OAAO,OAAO,iBAAiB,EAAE,SAAS,MAAM;AAAA,IACpE,iBACE,OAAO,OAAO,iBAAiB,EAAE,SAAS,gBAAgB;AAAA,IAC5D,iBACE,OAAO,OAAO,iBAAiB,EAAE,SAAS,gBAAgB;AAAA,IAC5D,kBAAkB,OAAO,OAAO,oBAAoB;AAAA,IACpD,cAAc,OAAO,OAAO,eAAe;AAAA,EAAA,CAC5C;AAED,OAAK,KAAK,SAAS,QAAQ,MAAM,WAAW;AAG5C,YAAU,6BACN,QAAQ;AAAA,IAAO,CAAC,WACd,OAAO,OAAO,eAAe,EAAE;AAAA,MAAK,CAAC,SACnC,uBAAuB,IAAI,EAAE,IAAI,OAAO,EAAE;AAAA,IAAA;AAAA,EAC5C,IAEF;AAEJ,MAAI,4BAA4B;AAC9B,SAAK;AAAA,MACH,oCAAoC,QAAQ,MAAM;AAAA,IAAA;AAAA,EAEtD;AAGA,MAAI,eAAe,EAAE;AAAA,IACnB,QAAQ,QAAQ,CAAC,WAAW,OAAO,wBAAwB,KAAK;AAAA,IAChE;AAAA,EAAA,EACA,OAAO,CAAC,OAAO,CAAC,CAAC,EAAE;AAErB,OAAK;AAAA,IACH,SAAS,aAAa,MAAM;AAAA,EAAA;AAG9B,iBAAe,aAAa;AAAA,IAC1B,CAAC;AAAA;AAAA,MAEC,GAAG,gBAAgB,kBACjB,GAAGA,cAAAA,QAAQ,KAAK,KAAK,IAAIA,cAAAA,QAAQ,KAAK,IAAI;AAAA,MAE5C,GAAG;AAAA;AAAA,EAAA;AAGP,OAAK;AAAA,IACH,oBAAoB,aAAa,MAAM,2BAA2B,aAC/D,IAAI,CAAC,OAAO,IAAI,GAAG,MAAM,EAAE,EAC3B,KAAK,IAAI,CAAC;AAAA,EAAA;AAGf,SAAO,EAAE,SAAS,aAAA;AACpB;"}