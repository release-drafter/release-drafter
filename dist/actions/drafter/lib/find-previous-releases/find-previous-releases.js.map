{"version":3,"file":"find-previous-releases.js","sources":["../../../../../src/actions/drafter/lib/find-previous-releases/find-previous-releases.ts"],"sourcesContent":["import { getOctokit } from 'src/common'\nimport { Config } from 'src/types'\nimport { context } from '@actions/github'\nimport * as core from '@actions/core'\nimport { sortReleases } from './sort-releases'\n\n// GitHub API currently returns a 500 HTTP response if you attempt to fetch over 1000 releases.\nconst RELEASE_COUNT_LIMIT = 1000\n\n/**\n * Lists every release and :\n * - filters by commitish if specified\n * - filters by tag-prefix if specified\n * - filters out pre-releases unless specified\n * - extracts the first draft releases (according to return-order of GitHub API)\n * - get latest published release according to ./sort-releases.ts implementation\n *\n * Returns one of (or both) draft release and latest published release\n */\nexport const findPreviousReleases = async (\n  params: Pick<\n    Config,\n    'commitish' | 'filter-by-commitish' | 'include-pre-releases' | 'tag-prefix'\n  >\n) => {\n  const {\n    commitish,\n    'filter-by-commitish': filterByCommitish,\n    'include-pre-releases': includePreReleases,\n    'tag-prefix': tagPrefix\n  } = params\n  const octokit = getOctokit()\n\n  core.info('Fetching releases from GitHub...')\n\n  let releaseCount = 0\n  const releases = await octokit.paginate(\n    octokit.rest.repos.listReleases,\n    {\n      ...context.repo,\n      per_page: 100\n    },\n    (response, done) => {\n      releaseCount += response.data.length\n      if (releaseCount >= RELEASE_COUNT_LIMIT) {\n        done()\n      }\n      return response.data\n    }\n  )\n\n  core.info(`Found ${releases.length} releases`)\n\n  // `refs/heads/branch` and `branch` are the same thing in this context\n  const headRefRegex = /^refs\\/heads\\//\n  const targetCommitishName = commitish.replace(headRefRegex, '')\n  const commitishFilteredReleases = filterByCommitish\n    ? releases.filter(\n        (r) =>\n          targetCommitishName === r.target_commitish.replace(headRefRegex, '')\n      )\n    : releases\n  const filteredReleases = tagPrefix\n    ? commitishFilteredReleases.filter((r) => r.tag_name.startsWith(tagPrefix))\n    : commitishFilteredReleases\n  const sortedSelectedReleases = sortReleases({\n    releases: filteredReleases.filter(\n      (r) => !r.draft && (!r.prerelease || includePreReleases)\n    ),\n    tagPrefix\n  })\n  const draftRelease = filteredReleases.find(\n    (r) => r.draft && r.prerelease === includePreReleases\n  )\n  const lastRelease = sortedSelectedReleases.at(-1)\n\n  if (draftRelease) {\n    core.info(`Draft release: ${draftRelease.tag_name}`)\n  } else {\n    core.info(`No draft release found`)\n  }\n\n  if (lastRelease) {\n    core.info(\n      `Last release${\n        includePreReleases ? ' (including prerelease)' : ''\n      }: ${lastRelease.tag_name}`\n    )\n  } else {\n    core.info(`No last release found`)\n  }\n\n  return { draftRelease, lastRelease }\n}\n"],"names":["core.info","context"],"mappings":";;;;;;;;;;;;AAOA,MAAM,sBAAsB;AAYrB,MAAM,uBAAuB,OAClC,WAIG;AACH,QAAM;AAAA,IACJ;AAAA,IACA,uBAAuB;AAAA,IACvB,wBAAwB;AAAA,IACxB,cAAc;AAAA,EAAA,IACZ;AACJ,QAAM,UAAU,WAAA;AAEhBA,cAAAA,KAAU,kCAAkC;AAE5C,MAAI,eAAe;AACnB,QAAM,WAAW,MAAM,QAAQ;AAAA,IAC7B,QAAQ,KAAK,MAAM;AAAA,IACnB;AAAA,MACE,GAAGC,cAAAA,QAAQ;AAAA,MACX,UAAU;AAAA,IAAA;AAAA,IAEZ,CAAC,UAAU,SAAS;AAClB,sBAAgB,SAAS,KAAK;AAC9B,UAAI,gBAAgB,qBAAqB;AACvC,aAAA;AAAA,MACF;AACA,aAAO,SAAS;AAAA,IAClB;AAAA,EAAA;AAGFD,cAAAA,KAAU,SAAS,SAAS,MAAM,WAAW;AAG7C,QAAM,eAAe;AACrB,QAAM,sBAAsB,UAAU,QAAQ,cAAc,EAAE;AAC9D,QAAM,4BAA4B,oBAC9B,SAAS;AAAA,IACP,CAAC,MACC,wBAAwB,EAAE,iBAAiB,QAAQ,cAAc,EAAE;AAAA,EAAA,IAEvE;AACJ,QAAM,mBAAmB,YACrB,0BAA0B,OAAO,CAAC,MAAM,EAAE,SAAS,WAAW,SAAS,CAAC,IACxE;AACJ,QAAM,yBAAyB,aAAa;AAAA,IAC1C,UAAU,iBAAiB;AAAA,MACzB,CAAC,MAAM,CAAC,EAAE,UAAU,CAAC,EAAE,cAAc;AAAA,IAAA;AAAA,IAEvC;AAAA,EAAA,CACD;AACD,QAAM,eAAe,iBAAiB;AAAA,IACpC,CAAC,MAAM,EAAE,SAAS,EAAE,eAAe;AAAA,EAAA;AAErC,QAAM,cAAc,uBAAuB,GAAG,EAAE;AAEhD,MAAI,cAAc;AAChBA,gBAAAA,KAAU,kBAAkB,aAAa,QAAQ,EAAE;AAAA,EACrD,OAAO;AACLA,gBAAAA,KAAU,wBAAwB;AAAA,EACpC;AAEA,MAAI,aAAa;AACfA,gBAAAA;AAAAA,MACE,eACE,qBAAqB,4BAA4B,EACnD,KAAK,YAAY,QAAQ;AAAA,IAAA;AAAA,EAE7B,OAAO;AACLA,gBAAAA,KAAU,uBAAuB;AAAA,EACnC;AAEA,SAAO,EAAE,cAAc,YAAA;AACzB;"}