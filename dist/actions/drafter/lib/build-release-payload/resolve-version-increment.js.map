{"version":3,"file":"resolve-version-increment.js","sources":["../../../../../src/actions/drafter/lib/build-release-payload/resolve-version-increment.ts"],"sourcesContent":["import { Config } from 'src/types'\nimport { findPullRequests } from '../find-pull-requests'\nimport * as core from '@actions/core'\nimport {\n  getFilterExcludedPullRequests,\n  getFilterIncludedPullRequests\n} from './categorize-pull-requests'\nimport * as semver from 'semver'\n\nexport const resolveVersionKeyIncrement = (params: {\n  pullRequests: Awaited<ReturnType<typeof findPullRequests>>['pullRequests']\n  config: Pick<\n    Config,\n    | 'version-resolver'\n    | 'prerelease'\n    | 'prerelease-identifier'\n    | 'exclude-labels'\n    | 'include-labels'\n  >\n}): semver.ReleaseType => {\n  const { pullRequests, config } = params\n\n  const priorityMap = {\n    patch: 1,\n    minor: 2,\n    major: 3\n  }\n\n  const labelToKeyMap: Record<string, keyof typeof priorityMap> =\n    Object.fromEntries(\n      Object.keys(priorityMap)\n        .flatMap((key) => [\n          config['version-resolver'][\n            key as keyof typeof priorityMap\n          ].labels.map((label) => [label, key])\n        ])\n        .flat()\n    )\n\n  core.debug('labelToKeyMap: ' + JSON.stringify(labelToKeyMap))\n\n  const keys = pullRequests\n    .filter(getFilterExcludedPullRequests(config['exclude-labels']))\n    .filter(getFilterIncludedPullRequests(config['include-labels']))\n    .flatMap((pr) =>\n      pr.labels?.nodes\n        ?.filter((n) => !!n?.name)\n        .map((node) => labelToKeyMap[node!.name])\n    )\n    .filter(Boolean) as (keyof typeof priorityMap)[]\n\n  core.debug('keys: ' + JSON.stringify(keys))\n\n  const keyPriorities = keys.map((key) => priorityMap[key])\n  const priority = Math.max(...keyPriorities)\n  const versionKey = Object.keys(priorityMap).find(\n    (key) => priorityMap[key as keyof typeof priorityMap] === priority\n  ) as keyof typeof priorityMap | undefined\n\n  core.debug('versionKey: ' + versionKey)\n\n  const versionKeyIncrement = versionKey || config['version-resolver'].default\n\n  const shouldIncrementAsPrerelease =\n    config['prerelease'] && config['prerelease-identifier']\n\n  if (!shouldIncrementAsPrerelease) {\n    return versionKeyIncrement\n  }\n\n  return `pre${versionKeyIncrement}`\n}\n"],"names":["core.debug"],"mappings":";;AASO,MAAM,6BAA6B,CAAC,WAUjB;AACxB,QAAM,EAAE,cAAc,OAAA,IAAW;AAEjC,QAAM,cAAc;AAAA,IAClB,OAAO;AAAA,IACP,OAAO;AAAA,IACP,OAAO;AAAA,EAAA;AAGT,QAAM,gBACJ,OAAO;AAAA,IACL,OAAO,KAAK,WAAW,EACpB,QAAQ,CAAC,QAAQ;AAAA,MAChB,OAAO,kBAAkB,EACvB,GACF,EAAE,OAAO,IAAI,CAAC,UAAU,CAAC,OAAO,GAAG,CAAC;AAAA,IAAA,CACrC,EACA,KAAA;AAAA,EAAK;AAGZA,cAAAA,MAAW,oBAAoB,KAAK,UAAU,aAAa,CAAC;AAE5D,QAAM,OAAO,aACV,OAAO,8BAA8B,OAAO,gBAAgB,CAAC,CAAC,EAC9D,OAAO,8BAA8B,OAAO,gBAAgB,CAAC,CAAC,EAC9D;AAAA,IAAQ,CAAC,OACR,GAAG,QAAQ,OACP,OAAO,CAAC,MAAM,CAAC,CAAC,GAAG,IAAI,EACxB,IAAI,CAAC,SAAS,cAAc,KAAM,IAAI,CAAC;AAAA,EAAA,EAE3C,OAAO,OAAO;AAEjBA,cAAAA,MAAW,WAAW,KAAK,UAAU,IAAI,CAAC;AAE1C,QAAM,gBAAgB,KAAK,IAAI,CAAC,QAAQ,YAAY,GAAG,CAAC;AACxD,QAAM,WAAW,KAAK,IAAI,GAAG,aAAa;AAC1C,QAAM,aAAa,OAAO,KAAK,WAAW,EAAE;AAAA,IAC1C,CAAC,QAAQ,YAAY,GAA+B,MAAM;AAAA,EAAA;AAG5DA,cAAAA,MAAW,iBAAiB,UAAU;AAEtC,QAAM,sBAAsB,cAAc,OAAO,kBAAkB,EAAE;AAErE,QAAM,8BACJ,OAAO,YAAY,KAAK,OAAO,uBAAuB;AAExD,MAAI,CAAC,6BAA6B;AAChC,WAAO;AAAA,EACT;AAEA,SAAO,MAAM,mBAAmB;AAClC;"}