{"version":3,"file":"categorize-pull-requests.js","sources":["../../../../../src/actions/drafter/lib/build-release-payload/categorize-pull-requests.ts"],"sourcesContent":["import { Config } from 'src/types'\nimport { findPullRequests } from '../find-pull-requests'\n\ntype Pr = Awaited<ReturnType<typeof findPullRequests>>['pullRequests'][number]\n\nexport const categorizePullRequests = (params: {\n  pullRequests: Pr[]\n  config: Pick<Config, 'exclude-labels' | 'include-labels' | 'categories'>\n}): [Pr[], (Config['categories'][number] & { pullRequests: Pr[] })[]] => {\n  const { pullRequests, config } = params\n\n  const allCategoryLabels = new Set(\n    config.categories.flatMap((category) => category.labels)\n  )\n  const uncategorizedPullRequests: Pr[] = []\n  const categorizedPullRequests: (Config['categories'][number] & {\n    pullRequests: Pr[]\n  })[] = [...config.categories].map((category) => {\n    return { ...category, pullRequests: [] }\n  })\n\n  const uncategorizedCategoryIndex = config.categories.findIndex(\n    (category) => category.labels.length === 0\n  )\n\n  const filterUncategorizedPullRequests = (pullRequest: Pr) => {\n    const labels = pullRequest.labels?.nodes || []\n\n    if (\n      labels.length === 0 ||\n      !labels.some(\n        (label) => !!label?.name && allCategoryLabels.has(label?.name)\n      )\n    ) {\n      if (uncategorizedCategoryIndex === -1) {\n        uncategorizedPullRequests.push(pullRequest)\n      } else {\n        categorizedPullRequests[uncategorizedCategoryIndex].pullRequests.push(\n          pullRequest\n        )\n      }\n      return false\n    }\n    return true\n  }\n\n  // we only want pull requests that have yet to be categorized\n  const filteredPullRequests = pullRequests\n    .filter(getFilterExcludedPullRequests(config['exclude-labels']))\n    .filter(getFilterIncludedPullRequests(config['include-labels']))\n    .filter((pullRequest) => filterUncategorizedPullRequests(pullRequest))\n\n  for (const category of categorizedPullRequests) {\n    for (const pullRequest of filteredPullRequests) {\n      // lets categorize some pull request based on labels\n      // note that having the same label in multiple categories\n      // then it is intended to \"duplicate\" the pull request into each category\n      const labels = pullRequest.labels?.nodes || []\n      if (\n        labels.some(\n          (label) => !!label?.name && category.labels.includes(label.name)\n        )\n      ) {\n        category.pullRequests.push(pullRequest)\n      }\n    }\n  }\n\n  return [uncategorizedPullRequests, categorizedPullRequests]\n}\n\nexport const getFilterExcludedPullRequests = (\n  excludeLabels: Config['exclude-labels']\n) => {\n  return (pullRequest: Pr) => {\n    const labels = pullRequest.labels?.nodes || []\n    if (\n      labels.some(\n        (label) => !!label?.name && excludeLabels.includes(label.name)\n      )\n    ) {\n      return false\n    }\n    return true\n  }\n}\n\nexport const getFilterIncludedPullRequests = (\n  includeLabels: Config['include-labels']\n) => {\n  return (pullRequest: Pr) => {\n    const labels = pullRequest.labels?.nodes || []\n    if (\n      includeLabels.length === 0 ||\n      labels.some(\n        (label) => !!label?.name && includeLabels.includes(label.name)\n      )\n    ) {\n      return true\n    }\n    return false\n  }\n}\n"],"names":[],"mappings":"AAKO,MAAM,yBAAyB,CAAC,WAGkC;AACvE,QAAM,EAAE,cAAc,OAAA,IAAW;AAEjC,QAAM,oBAAoB,IAAI;AAAA,IAC5B,OAAO,WAAW,QAAQ,CAAC,aAAa,SAAS,MAAM;AAAA,EAAA;AAEzD,QAAM,4BAAkC,CAAA;AACxC,QAAM,0BAEC,CAAC,GAAG,OAAO,UAAU,EAAE,IAAI,CAAC,aAAa;AAC9C,WAAO,EAAE,GAAG,UAAU,cAAc,GAAC;AAAA,EACvC,CAAC;AAED,QAAM,6BAA6B,OAAO,WAAW;AAAA,IACnD,CAAC,aAAa,SAAS,OAAO,WAAW;AAAA,EAAA;AAG3C,QAAM,kCAAkC,CAAC,gBAAoB;AAC3D,UAAM,SAAS,YAAY,QAAQ,SAAS,CAAA;AAE5C,QACE,OAAO,WAAW,KAClB,CAAC,OAAO;AAAA,MACN,CAAC,UAAU,CAAC,CAAC,OAAO,QAAQ,kBAAkB,IAAI,OAAO,IAAI;AAAA,IAAA,GAE/D;AACA,UAAI,+BAA+B,IAAI;AACrC,kCAA0B,KAAK,WAAW;AAAA,MAC5C,OAAO;AACL,gCAAwB,0BAA0B,EAAE,aAAa;AAAA,UAC/D;AAAA,QAAA;AAAA,MAEJ;AACA,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AAGA,QAAM,uBAAuB,aAC1B,OAAO,8BAA8B,OAAO,gBAAgB,CAAC,CAAC,EAC9D,OAAO,8BAA8B,OAAO,gBAAgB,CAAC,CAAC,EAC9D,OAAO,CAAC,gBAAgB,gCAAgC,WAAW,CAAC;AAEvE,aAAW,YAAY,yBAAyB;AAC9C,eAAW,eAAe,sBAAsB;AAI9C,YAAM,SAAS,YAAY,QAAQ,SAAS,CAAA;AAC5C,UACE,OAAO;AAAA,QACL,CAAC,UAAU,CAAC,CAAC,OAAO,QAAQ,SAAS,OAAO,SAAS,MAAM,IAAI;AAAA,MAAA,GAEjE;AACA,iBAAS,aAAa,KAAK,WAAW;AAAA,MACxC;AAAA,IACF;AAAA,EACF;AAEA,SAAO,CAAC,2BAA2B,uBAAuB;AAC5D;AAEO,MAAM,gCAAgC,CAC3C,kBACG;AACH,SAAO,CAAC,gBAAoB;AAC1B,UAAM,SAAS,YAAY,QAAQ,SAAS,CAAA;AAC5C,QACE,OAAO;AAAA,MACL,CAAC,UAAU,CAAC,CAAC,OAAO,QAAQ,cAAc,SAAS,MAAM,IAAI;AAAA,IAAA,GAE/D;AACA,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AACF;AAEO,MAAM,gCAAgC,CAC3C,kBACG;AACH,SAAO,CAAC,gBAAoB;AAC1B,UAAM,SAAS,YAAY,QAAQ,SAAS,CAAA;AAC5C,QACE,cAAc,WAAW,KACzB,OAAO;AAAA,MACL,CAAC,UAAU,CAAC,CAAC,OAAO,QAAQ,cAAc,SAAS,MAAM,IAAI;AAAA,IAAA,GAE/D;AACA,aAAO;AAAA,IACT;AACA,WAAO;AAAA,EACT;AACF;"}