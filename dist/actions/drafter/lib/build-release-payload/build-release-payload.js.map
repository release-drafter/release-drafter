{"version":3,"file":"build-release-payload.js","sources":["../../../../../src/actions/drafter/lib/build-release-payload/build-release-payload.ts"],"sourcesContent":["import { Config, StandaloneInput } from 'src/types'\nimport { findPullRequests } from '../find-pull-requests'\nimport { findPreviousReleases } from '../find-previous-releases'\nimport { sortPullRequests } from './sort-pull-requests'\nimport { renderTemplate } from './render-template'\nimport { generateChangeLog } from './generate-changelog'\nimport { generateContributorsSentence } from './generate-contributors-sentence'\nimport { context } from '@actions/github'\nimport { resolveVersionKeyIncrement } from './resolve-version-increment'\n\nimport * as core from '@actions/core'\nimport { getVersionInfo } from './get-version-info'\n\n/**\n * Outputs the payload for creating or updating a release.\n *\n * Previously known as `generateReleaseInfo`.\n */\nexport const buildReleasePayload = (params: {\n  commits: Awaited<ReturnType<typeof findPullRequests>>['commits']\n  config: Pick<\n    Config,\n    | 'sort-by'\n    | 'sort-direction'\n    | 'header'\n    | 'footer'\n    | 'template'\n    | 'replacers'\n    | 'change-title-escapes'\n    | 'no-changes-template'\n    | 'exclude-labels'\n    | 'include-labels'\n    | 'categories'\n    | 'change-template'\n    | 'category-template'\n    | 'exclude-contributors'\n    | 'no-contributors-template'\n    | 'version-resolver'\n    | 'prerelease'\n    | 'version-template'\n    | 'tag-prefix'\n    | 'prerelease-identifier'\n    | 'tag-template'\n    | 'name-template'\n    | 'commitish'\n    | 'latest'\n  >\n  input: StandaloneInput\n  lastRelease: Awaited<ReturnType<typeof findPreviousReleases>>['lastRelease']\n  pullRequests: Awaited<ReturnType<typeof findPullRequests>>['pullRequests']\n}) => {\n  const { commits, config, input, lastRelease, pullRequests } = params\n\n  const sortedPullRequests = sortPullRequests({\n    pullRequests,\n    config\n  })\n\n  let body = config['header'] + config.template + config['footer']\n  body = renderTemplate({\n    template: body,\n    object: {\n      $PREVIOUS_TAG: lastRelease ? lastRelease.tag_name : '',\n      $CHANGES: generateChangeLog({ pullRequests: sortedPullRequests, config }),\n      $CONTRIBUTORS: generateContributorsSentence({\n        commits,\n        pullRequests: sortedPullRequests,\n        config\n      }),\n      $OWNER: context.repo.owner,\n      $REPOSITORY: context.repo.repo\n    },\n    replacers: config.replacers\n  })\n\n  const versionKeyIncrement = resolveVersionKeyIncrement({\n    pullRequests,\n    config\n  })\n\n  core.debug('versionKeyIncrement: ' + versionKeyIncrement)\n\n  const versionInfo = getVersionInfo({\n    lastRelease,\n    config,\n    input,\n    versionKeyIncrement\n  })\n\n  core.debug('versionInfo: ' + JSON.stringify(versionInfo, null, 2))\n\n  if (versionInfo) {\n    body = renderTemplate({ template: body, object: versionInfo })\n  }\n\n  let mutableInputTag = structuredClone(input['tag'])\n  let mutableInputName = structuredClone(input['name'])\n  let mutableCommitish = structuredClone(config['commitish'])\n\n  if (mutableInputTag === undefined) {\n    mutableInputTag = versionInfo\n      ? renderTemplate({\n          template: config['tag-template'] || '',\n          object: versionInfo\n        })\n      : ''\n  } else if (versionInfo) {\n    mutableInputTag = renderTemplate({\n      template: mutableInputTag,\n      object: versionInfo\n    })\n  }\n\n  core.debug('tag: ' + mutableInputTag)\n\n  if (mutableInputName === undefined) {\n    mutableInputName = versionInfo\n      ? renderTemplate({\n          template: config['name-template'] || '',\n          object: versionInfo\n        })\n      : ''\n  } else if (versionInfo) {\n    mutableInputName = renderTemplate({\n      template: mutableInputName,\n      object: versionInfo\n    })\n  }\n\n  core.debug('name: ' + mutableInputName)\n\n  /**\n   * Tags are not supported as `target_commitish` by Github API.\n   * GITHUB_REF or the ref from webhook start with `refs/tags/`, so we handle\n   * those here. If it doesn't but is still a tag - it must have been set\n   * explicitly by the user, so it's fair to just let the API respond with an error.\n   */\n  if (mutableCommitish.startsWith('refs/tags/')) {\n    core.info(\n      `${mutableCommitish} is not supported as release target, falling back to default branch`\n    )\n\n    mutableCommitish = ''\n  }\n\n  const resolvedVersion = versionInfo.$RESOLVED_VERSION?.version\n  const majorVersion = versionInfo.$RESOLVED_VERSION?.$MAJOR\n  const minorVersion = versionInfo.$RESOLVED_VERSION?.$MINOR\n  const patchVersion = versionInfo.$RESOLVED_VERSION?.$PATCH\n\n  return {\n    name: mutableInputName,\n    tag: mutableInputTag,\n    body,\n    targetCommitish: mutableCommitish,\n    prerelease: config['prerelease'],\n    make_latest: config['latest'],\n    draft: !input['publish'],\n    resolvedVersion,\n    majorVersion,\n    minorVersion,\n    patchVersion\n  }\n}\n"],"names":["context","core.debug","core.info"],"mappings":";;;;;;;;AAkBO,MAAM,sBAAsB,CAAC,WAgC9B;AACJ,QAAM,EAAE,SAAS,QAAQ,OAAO,aAAa,iBAAiB;AAE9D,QAAM,qBAAqB,iBAAiB;AAAA,IAC1C;AAAA,IACA;AAAA,EAAA,CACD;AAED,MAAI,OAAO,OAAO,QAAQ,IAAI,OAAO,WAAW,OAAO,QAAQ;AAC/D,SAAO,eAAe;AAAA,IACpB,UAAU;AAAA,IACV,QAAQ;AAAA,MACN,eAAe,cAAc,YAAY,WAAW;AAAA,MACpD,UAAU,kBAAkB,EAAE,cAAc,oBAAoB,QAAQ;AAAA,MACxE,eAAe,6BAA6B;AAAA,QAC1C;AAAA,QACA,cAAc;AAAA,QACd;AAAA,MAAA,CACD;AAAA,MACD,QAAQA,cAAAA,QAAQ,KAAK;AAAA,MACrB,aAAaA,cAAAA,QAAQ,KAAK;AAAA,IAAA;AAAA,IAE5B,WAAW,OAAO;AAAA,EAAA,CACnB;AAED,QAAM,sBAAsB,2BAA2B;AAAA,IACrD;AAAA,IACA;AAAA,EAAA,CACD;AAEDC,cAAAA,MAAW,0BAA0B,mBAAmB;AAExD,QAAM,cAAc,eAAe;AAAA,IACjC;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA,CACD;AAEDA,cAAAA,MAAW,kBAAkB,KAAK,UAAU,aAAa,MAAM,CAAC,CAAC;AAEjE,MAAI,aAAa;AACf,WAAO,eAAe,EAAE,UAAU,MAAM,QAAQ,aAAa;AAAA,EAC/D;AAEA,MAAI,kBAAkB,gBAAgB,MAAM,KAAK,CAAC;AAClD,MAAI,mBAAmB,gBAAgB,MAAM,MAAM,CAAC;AACpD,MAAI,mBAAmB,gBAAgB,OAAO,WAAW,CAAC;AAE1D,MAAI,oBAAoB,QAAW;AACjC,sBAAkB,cACd,eAAe;AAAA,MACb,UAAU,OAAO,cAAc,KAAK;AAAA,MACpC,QAAQ;AAAA,IAAA,CACT,IACD;AAAA,EACN,WAAW,aAAa;AACtB,sBAAkB,eAAe;AAAA,MAC/B,UAAU;AAAA,MACV,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAEAA,cAAAA,MAAW,UAAU,eAAe;AAEpC,MAAI,qBAAqB,QAAW;AAClC,uBAAmB,cACf,eAAe;AAAA,MACb,UAAU,OAAO,eAAe,KAAK;AAAA,MACrC,QAAQ;AAAA,IAAA,CACT,IACD;AAAA,EACN,WAAW,aAAa;AACtB,uBAAmB,eAAe;AAAA,MAChC,UAAU;AAAA,MACV,QAAQ;AAAA,IAAA,CACT;AAAA,EACH;AAEAA,cAAAA,MAAW,WAAW,gBAAgB;AAQtC,MAAI,iBAAiB,WAAW,YAAY,GAAG;AAC7CC,gBAAAA;AAAAA,MACE,GAAG,gBAAgB;AAAA,IAAA;AAGrB,uBAAmB;AAAA,EACrB;AAEA,QAAM,kBAAkB,YAAY,mBAAmB;AACvD,QAAM,eAAe,YAAY,mBAAmB;AACpD,QAAM,eAAe,YAAY,mBAAmB;AACpD,QAAM,eAAe,YAAY,mBAAmB;AAEpD,SAAO;AAAA,IACL,MAAM;AAAA,IACN,KAAK;AAAA,IACL;AAAA,IACA,iBAAiB;AAAA,IACjB,YAAY,OAAO,YAAY;AAAA,IAC/B,aAAa,OAAO,QAAQ;AAAA,IAC5B,OAAO,CAAC,MAAM,SAAS;AAAA,IACvB;AAAA,IACA;AAAA,IACA;AAAA,IACA;AAAA,EAAA;AAEJ;"}