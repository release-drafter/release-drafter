{"version":3,"file":"paginate-graphql.js","sources":["../../src/common/paginate-graphql.ts"],"sourcesContent":["import { RequestParameters } from '@octokit/graphql/types'\nimport _ from 'lodash'\n\n/**\n * Utility function to paginate a GraphQL function using Relay-style cursor pagination.\n *\n * @param {Function} queryFn - function used to query the GraphQL API\n * @param {string} query - GraphQL query, must include `nodes` and `pageInfo` fields for the field that will be paginated\n * @param {Object} variables\n * @param {string[]} paginatePath - path to field to paginate\n */\nexport async function paginateGraphql<T extends object>(\n  client: typeof import('@octokit/graphql').graphql,\n  query: string,\n  requestParameters: RequestParameters,\n  paginatePath: string[]\n) {\n  const nodesPath = [...paginatePath, 'nodes']\n  const pageInfoPath = [...paginatePath, 'pageInfo']\n  const endCursorPath = [...pageInfoPath, 'endCursor']\n  const hasNextPagePath = [...pageInfoPath, 'hasNextPage']\n  const hasNextPage = (data: T) => _.get(data, hasNextPagePath)\n\n  const data = await client<T>(query, requestParameters)\n\n  if (!_.has(data, nodesPath)) {\n    throw new Error(\n      \"Data doesn't contain `nodes` field. Make sure the `paginatePath` is set to the field you wish to paginate and that the query includes the `nodes` field.\"\n    )\n  }\n\n  if (\n    !_.has(data, pageInfoPath) ||\n    !_.has(data, endCursorPath) ||\n    !_.has(data, hasNextPagePath)\n  ) {\n    throw new Error(\n      \"Data doesn't contain `pageInfo` field with `endCursor` and `hasNextPage` fields. Make sure the `paginatePath` is set to the field you wish to paginate and that the query includes the `pageInfo` field.\"\n    )\n  }\n\n  while (hasNextPage(data)) {\n    const newData = await client<T>(query, {\n      ...requestParameters,\n      after: _.get(data, [...pageInfoPath, 'endCursor'])\n    })\n    const newNodes = _.get(newData, nodesPath)\n    const newPageInfo = _.get(newData, pageInfoPath)\n\n    _.set(data, pageInfoPath, newPageInfo)\n    _.update(data, nodesPath, (d) => [...d, ...newNodes])\n  }\n\n  return data\n}\n"],"names":["data"],"mappings":";AAWA,eAAsB,gBACpB,QACA,OACA,mBACA,cACA;AACA,QAAM,YAAY,CAAC,GAAG,cAAc,OAAO;AAC3C,QAAM,eAAe,CAAC,GAAG,cAAc,UAAU;AACjD,QAAM,gBAAgB,CAAC,GAAG,cAAc,WAAW;AACnD,QAAM,kBAAkB,CAAC,GAAG,cAAc,aAAa;AACvD,QAAM,cAAc,CAACA,UAAY,EAAE,IAAIA,OAAM,eAAe;AAE5D,QAAM,OAAO,MAAM,OAAU,OAAO,iBAAiB;AAErD,MAAI,CAAC,EAAE,IAAI,MAAM,SAAS,GAAG;AAC3B,UAAM,IAAI;AAAA,MACR;AAAA,IAAA;AAAA,EAEJ;AAEA,MACE,CAAC,EAAE,IAAI,MAAM,YAAY,KACzB,CAAC,EAAE,IAAI,MAAM,aAAa,KAC1B,CAAC,EAAE,IAAI,MAAM,eAAe,GAC5B;AACA,UAAM,IAAI;AAAA,MACR;AAAA,IAAA;AAAA,EAEJ;AAEA,SAAO,YAAY,IAAI,GAAG;AACxB,UAAM,UAAU,MAAM,OAAU,OAAO;AAAA,MACrC,GAAG;AAAA,MACH,OAAO,EAAE,IAAI,MAAM,CAAC,GAAG,cAAc,WAAW,CAAC;AAAA,IAAA,CAClD;AACD,UAAM,WAAW,EAAE,IAAI,SAAS,SAAS;AACzC,UAAM,cAAc,EAAE,IAAI,SAAS,YAAY;AAE/C,MAAE,IAAI,MAAM,cAAc,WAAW;AACrC,MAAE,OAAO,MAAM,WAAW,CAAC,MAAM,CAAC,GAAG,GAAG,GAAG,QAAQ,CAAC;AAAA,EACtD;AAEA,SAAO;AACT;"}